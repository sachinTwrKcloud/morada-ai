<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Messages Live</title>
    <style>
        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        #messages > li {
            padding: 0.5rem 1rem;
        }

        #messages > li:nth-child(odd) {
            background: #efefef;
        }

        #header-id {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 0;
            padding: 0.5rem 1rem;
            position: sticky;
            top: 0;
            background: #ccc;
        }
    </style>
</head>
<body>
<div id="header-id">
    <button id="connect-id" onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
    <input id="session-id" placeholder="Session" />
    <input id="conversation-id" placeholder="Conversation" />
    <button id="listen-id" onclick="listen()">Listen</button>
    <button onclick="stop()">Stop</button>

    <div style="width:100%">
        Test <input id="count-id" placeholder="Count" /> connections
        <button id="connect-many-id" onclick="connectMany()">Connect</button>
    </div>
</div>
<ul id="messages"></ul>

<script src="/socket.io/socket.io.js"></script>

<script>
    const messagesElement = document.getElementById("messages");
    let item;
    const createMessageElements = (messageIds) => {
        for (const messageId of messageIds) {
            item = document.createElement("li");
            item.setAttribute("id", `message_${messageId}`);
            item.innerHTML = `Message #${messageId}`;
            messagesElement.appendChild(item);
        }
        window.scrollTo(0, document.body.scrollHeight);
    }

    const NEW_MESSAGES = "NEW_MESSAGES";
    const LISTEN_CONVERSATION = "LISTEN_CONVERSATION";
    const STOP_LISTENING_CONVERSATION = "STOP_LISTENING_CONVERSATION";
    const ERROR = "EVENT_ERROR";

    const sockets = [];

    function connectMany() {
        const count = +document.getElementById('count-id').value;
        for (let index = 0; index < count; index++) {
            connect(index);
            listen(index)
        }
    }

    function connect(index = 0) {
        document.getElementById('connect-id').setAttribute("disabled", "disabled");
        document.getElementById('connect-many-id').setAttribute("disabled", "disabled");

        sockets[index] = io({
            auth: {
                services: ["live"],
            }
        });

        sockets[index].onAny((eventName, payload) => {
            console.log(eventName, payload);
        });
        sockets[index].on(ERROR, ({ message }) => {
            console.error(message);
        });
    }

    function disconnect(index = 0) {
        document.getElementById('connect-id').removeAttribute("disabled");
        sockets[index].disconnect();
    }

    function listen(index = 0, conversationMock) {
        document.getElementById('listen-id').setAttribute("disabled", "disabled");
        const conversationId = conversationMock || document.getElementById("conversation-id").value;
        const session = document.getElementById("session-id").value;

        sockets[index]?.on(NEW_MESSAGES, createMessageElements);
        sockets[index]?.emit(LISTEN_CONVERSATION, { conversationId, session: session });
    }

    function stop(index = 0) {
        const conversationId = document.getElementById("conversation-id").value;
        sockets[index]?.off(NEW_MESSAGES, createMessageElements);
        sockets[index]?.emit(STOP_LISTENING_CONVERSATION, conversationId);
    }
</script>

</body>
</html>
